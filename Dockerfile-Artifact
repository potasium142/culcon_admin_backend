# Build stage
FROM docker.io/python:3.10.15-slim-bookworm AS builder

WORKDIR /build

# Install system dependencies needed for building
RUN apt-get update && apt-get install -y --no-install-recommends \
    wget \
    curl \
    libpq-dev \
    && rm -rf /var/lib/apt/lists/*

# Copy and install requirements
COPY ./requirements.txt .
RUN pip install --no-cache-dir -r requirements.txt

# Download AI model weights
RUN mkdir -p /build/ai/weights
RUN curl -sS -L -o /tmp/model.tar.gz "https://www.kaggle.com/api/v1/models/letruonggiangk17ct/culcon_yolo/pyTorch/default/2/download" && \
    tar -xf /tmp/model.tar.gz -C /build/ai/weights && \
    rm /tmp/model.tar.gz
    
RUN curl -sS -L -o /build/ai/weights/ViT-L-14-336px.pt "https://openaipublic.azureedge.net/clip/models/b8cca3fd41ae0c99ba7e8951adf17d267cdb84cd88be6f7c2e0eca1737a03836/ViT-L-14.pt"

# Runtime stage
FROM docker.io/python:3.10.15-slim-bookworm

WORKDIR /workdir

EXPOSE 8000

ENV DB_URL=postgresql+psycopg://postgres.vybaqlunzfrjpxsnnvmn:gPk9zs4HHefgHk9T@aws-0-ap-southeast-1.pooler.supabase.com:6543/postgres

# Install only runtime dependencies
RUN apt-get update && apt-get install -y --no-install-recommends \
    libpq-dev \
    libgl1 \
    libglib2.0-0 \
    && rm -rf /var/lib/apt/lists/*

# Copy installed Python packages from builder
COPY --from=builder /usr/local/lib/python3.10/site-packages /usr/local/lib/python3.10/site-packages
COPY --from=builder /usr/local/bin /usr/local/bin

# Copy AI weights from builder
COPY --from=builder /build/ai/weights /workdir/ai/weights

# Copy application code
COPY . .

ENTRYPOINT ["fastapi", "run", "main.py"]
